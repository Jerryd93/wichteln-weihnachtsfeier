<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Geheimes Wichteln üéÑ</title>
  <style>
    body{font-family:Inter,Arial,sans-serif;background:#f9f4f1;margin:0;padding:2rem;color:#222;text-align:center;}
    h1{color:#b22222;margin-bottom:0.25rem;}
    input,button{padding:.6rem .8rem;margin:.3rem;border-radius:8px;border:1px solid #ccc;font-size:1rem;}
    button{background:#b22222;color:white;cursor:pointer;}
    button:hover{background:#8b0000;}
    .card{background:#fff;padding:1rem;border-radius:12px;max-width:900px;margin:1rem auto;box-shadow:0 4px 10px rgba(0,0,0,0.08);text-align:left;}
    ul{list-style:none;padding:0}
    li{margin:.4rem 0;padding:.4rem .6rem;border-radius:8px;background:#fff8f6;border:1px solid #eee;}
    #adminPanel{display:none;margin-top:1rem;}
    .guide{background:#fff8f6;border-left:5px solid #b22222;padding:1rem;border-radius:8px;max-width:900px;margin:0 auto 1rem;text-align:left;line-height:1.6;}
    .guide h2{margin-top:0;color:#b22222;}
    .top{display:flex;gap:1rem;align-items:center;justify-content:space-between;}
    .muted{color:#666;font-size:.95rem}
    @media (max-width:700px){ .top{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <div class="top" style="max-width:900px;margin:0 auto 0.5rem;">
    <div>
      <h1>üéÅ Ace & Tate Wichteln</h1>
      <div class="muted">Einfach, geheim & ein bisschen magisch ‚ú®</div>
    </div>
  </div>

  <div class="guide" role="region" aria-label="Anleitung">
    <h2>üéÖ So funktioniert das Wichteln:</h2>
    <ol>
      <li>Gib deinen <strong>Namen</strong> ein und klicke auf <strong>‚ÄûHinzuf√ºgen‚Äú</strong>.</li>
      <li>Du bekommst einen <strong>PIN-Code</strong> ‚Äî bitte <u>unbedingt aufschreiben!</u></li>
      <li>Wenn alle eingetragen sind, startet der Admin das Wichteln (gesch√ºtzt durch Passwort).</li>
      <li>Danach kannst du mit deinem PIN herausfinden, <strong>wen du beschenkst üéÅ</strong>.</li>
      <li>Nur der Admin kann alles zur√ºcksetzen oder neu starten.</li>
    </ol>
  </div>

  <div class="card" aria-labelledby="addTitle">
    <h2 id="addTitle">Teilnehmer hinzuf√ºgen</h2>
    <input type="text" id="name" placeholder="Name" />
    <button id="addBtn">Hinzuf√ºgen</button>
    <p id="pinInfo" class="muted"></p>
  </div>

  <div class="card" aria-labelledby="listTitle">
    <h2 id="listTitle">Teilnehmerliste</h2>
    <ul id="list" aria-live="polite"></ul>

    <div id="adminLogin" style="margin-top:1rem;">
      <h3>üîê Admin Login</h3>
      <input type="password" id="adminPw" placeholder="Admin-Passwort" />
      <button id="loginBtn">Login</button>
      <p id="loginStatus" style="color:red;"></p>
    </div>

    <div id="adminPanel" aria-hidden="true">
      <h3>üõ†Ô∏è Admin-Bereich</h3>
      <p>Status: <span id="statusText"></span></p>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
        <button id="startBtn">Wichteln starten</button>
        <button id="resetBtn" style="background:#777;">Alles zur√ºcksetzen</button>
        <button id="logoutBtn" style="background:#555;">Logout</button>
      </div>
    </div>
  </div>

  <div class="card" aria-labelledby="revealTitle">
    <h2 id="revealTitle">Zuteilung anzeigen</h2>
    <input type="text" id="pin" placeholder="Dein PIN-Code" />
    <button id="revealBtn">Ziehen</button>
    <p id="result" class="muted"></p>
  </div>

  <script>
    const apiBase = "/api";
    let adminLoggedIn = false;
    // Admin-PW (Frontend nur zur Anzeige des Admin-Panel-UX). Backend pr√ºft wirklich.
    const adminPassword = "wichteladmin93";

    // DOM
    const addBtn = document.getElementById("addBtn");
    const addInput = document.getElementById("name");
    const pinInfo = document.getElementById("pinInfo");
    const listEl = document.getElementById("list");
    const loginBtn = document.getElementById("loginBtn");
    const adminPwInput = document.getElementById("adminPw");
    const loginStatus = document.getElementById("loginStatus");
    const adminPanel = document.getElementById("adminPanel");
    const adminLogin = document.getElementById("adminLogin");
    const statusText = document.getElementById("statusText");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const revealBtn = document.getElementById("revealBtn");
    const pinInput = document.getElementById("pin");
    const resultP = document.getElementById("result");

    addBtn.addEventListener("click", addParticipant);
    addInput.addEventListener("keydown", e => { if (e.key === "Enter") addParticipant(); });
    loginBtn.addEventListener("click", loginAdmin);
    startBtn.addEventListener("click", startWichteln);
    resetBtn.addEventListener("click", resetAll);
    logoutBtn.addEventListener("click", logoutAdmin);
    revealBtn.addEventListener("click", reveal);
    pinInput.addEventListener("keydown", e => { if (e.key === "Enter") reveal(); });

    async function addParticipant() {
      const name = addInput.value.trim();
      if (!name) return alert("Bitte einen Namen eingeben!");
      const res = await fetch(apiBase + "/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name }),
      });
      const data = await res.json();
      if (data.error) return alert(data.error);
      pinInfo.textContent = `Dein PIN: ${data.pin} ‚Äî bitte sicher aufbewahren!`;
      addInput.value = "";
      loadList();
    }

    async function loadList() {
      try {
        const res = await fetch(apiBase + "/list");
        const data = await res.json();
        listEl.innerHTML = (data.names && data.names.length)
          ? data.names.map(n => `<li>${escapeHtml(n)}</li>`).join("")
          : "<li class='muted'>Keine Teilnehmer</li>";
        statusText.textContent = data.started ? "Gestartet" : "Noch nicht gestartet";
      } catch (e) {
        listEl.innerHTML = "<li class='muted'>Fehler beim Laden</li>";
      }
    }

    async function startWichteln() {
      if (!adminLoggedIn) return alert("Bitte zuerst als Admin einloggen.");
      if (!confirm("Wichteln starten? Danach keine √Ñnderungen mehr m√∂glich.")) return;
      const res = await fetch(apiBase + "/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: adminPassword }),
      });
      const data = await res.json();
      if (data.error) return alert(data.error);
      alert("Zuteilung erstellt! Jeder Teilnehmer kann nun mit seinem PIN ziehen.");
      loadList();
    }

    async function reveal() {
      const pin = pinInput.value.trim();
      if (!pin) return alert("Bitte deinen PIN eingeben!");
      const res = await fetch(apiBase + "/reveal", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pin }),
      });
      const data = await res.json();
      resultP.textContent = data.error ? data.error : `Du beschenkst: ${data.recipient}`;
    }

    async function resetAll() {
      if (!adminLoggedIn) return alert("Bitte zuerst als Admin einloggen.");
      if (!confirm("Wirklich alles zur√ºcksetzen? Diese Aktion l√∂scht alle Daten.")) return;
      const res = await fetch(apiBase + "/reset", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: adminPassword }),
      });
      const data = await res.json();
      if (data.error) return alert(data.error);
      alert("Alle Daten wurden zur√ºckgesetzt.");
      loadList();
    }

    function loginAdmin() {
      const pw = adminPwInput.value.trim();
      if (pw === adminPassword) {
        adminLoggedIn = true;
        adminLogin.style.display = "none";
        adminPanel.style.display = "block";
        loginStatus.textContent = "";
        adminPwInput.value = "";
      } else {
        loginStatus.textContent = "Falsches Passwort.";
      }
    }

    function logoutAdmin() {
      adminLoggedIn = false;
      adminLogin.style.display = "block";
      adminPanel.style.display = "none";
    }

    // einfache HTML-escape
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // initial
    loadList();
  </script>
</body>
</html>
